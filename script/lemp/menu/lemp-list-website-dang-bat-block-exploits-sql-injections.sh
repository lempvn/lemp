#!/bin/bash
. /home/lemp.conf
echo "-------------------------------------------------------------------------"
echo "Please wait ..."
sleep 1
rm -rf /tmp/*vpsvn*
mkdir -p /tmp/sitedangbatsqlinjectvpsvn
ls /etc/nginx/conf.d > /tmp/lemp-websitelist
sed -i 's/\.conf//g' /tmp/lemp-websitelist 
sowebsitetrenserver=$(cat /tmp/lemp-websitelist | wc -l)
sowebsite=$(cat /tmp/lemp-websitelist)

for website in $sowebsite 
do
    if [ -f /etc/nginx/conf.d/$website.conf ]; then
        # Kiem tra neu dong include khong bi comment
        if grep -q "include /etc/nginx/conf/block.conf;" /etc/nginx/conf.d/$website.conf && ! grep -q "^#.*include /etc/nginx/conf/block.conf;" /etc/nginx/conf.d/$website.conf; then
            touch /tmp/sitedangbatsqlinjectvpsvn/$website
        fi
    fi

    if [ -f /etc/nginx/conf.d/www.$website.conf ]; then
        # Kiem tra neu dong include khong bi comment
        if grep -q "include /etc/nginx/conf/block.conf;" /etc/nginx/conf.d/www.$website.conf && ! grep -q "^#.*include /etc/nginx/conf/block.conf;" /etc/nginx/conf.d/www.$website.conf; then
            touch /tmp/sitedangbatsqlinjectvpsvn/www.$website
        fi
    fi
done

clear
echo "========================================================================="
echo "Website on server: $sowebsitetrenserver"
echo "-------------------------------------------------------------------------"

if [ "$(ls -1 /tmp/sitedangbatsqlinjectvpsvn | wc -l)" == "0" ]; then
    echo "Website ENABLED [Block Exploits, SQL Injections]: 0"
else
    echo "Website ENABLED [Block Exploits, SQL Injections]: $(ls -1 /tmp/sitedangbatsqlinjectvpsvn | wc -l)"
    echo "-------------------------------------------------------------------------"
    ls /tmp/sitedangbatsqlinjectvpsvn | pr -3 -t
fi

/etc/lemp/menu/tienich/lemp-tien-ich.sh
